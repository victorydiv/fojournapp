RewriteEngine On

# PRIORITY ROUTES - Handle these first before anything else
# Route sitemap.xml to api.php (WORKING!)
RewriteRule ^sitemap\.xml$ /api.php?route=sitemap [L]

# Route robots.txt to Node.js backend  
RewriteRule ^robots\.txt$ /api.php?route=robots [L]

# API Proxy - Forward /api/* requests to PHP proxy (not direct to Node.js)
# Don't change anything - let api.php handle the full /api/... path
RewriteCond %{REQUEST_URI} ^/api/
RewriteRule ^api/ /api.php [L]

# Serve static image files from public directory
# This must come BEFORE the React app fallback
RewriteCond %{REQUEST_URI} ^/users/
RewriteCond %{DOCUMENT_ROOT}/public%{REQUEST_URI} -f
RewriteRule ^users/(.*)$ /public/users/$1 [L]

# Serve static avatar files from public directory
RewriteCond %{REQUEST_URI} ^/avatars/
RewriteCond %{DOCUMENT_ROOT}/public%{REQUEST_URI} -f
RewriteRule ^avatars/(.*)$ /public/avatars/$1 [L]

# Set proper MIME types and headers for images in the public directory
<FilesMatch "public/users/.*\.(jpg|jpeg|png|gif|webp)$">
    Header set Access-Control-Allow-Origin "*"
    Header set Cache-Control "public, max-age=86400"
</FilesMatch>

# Route blog URLs to Node.js backend for Facebook/social media bots
# This allows proper meta tag generation for social sharing
RewriteCond %{HTTP_USER_AGENT} (facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|WhatsApp|Applebot|GoogleBot) [NC]
RewriteRule ^blog/([^/]+)/?$ /api.php?route=blog&slug=$1 [L]

# Route public profile URLs to Node.js backend for Facebook/social media bots
# This allows proper meta tag generation for social sharing
RewriteCond %{HTTP_USER_AGENT} facebookexternalhit [NC,OR]
RewriteCond %{HTTP_USER_AGENT} facebookcatalog [NC,OR]
RewriteCond %{HTTP_USER_AGENT} Twitterbot [NC,OR]
RewriteCond %{HTTP_USER_AGENT} LinkedInBot [NC,OR]
RewriteCond %{HTTP_USER_AGENT} WhatsApp [NC,OR]
RewriteCond %{HTTP_USER_AGENT} Applebot [NC,OR]
RewriteCond %{HTTP_USER_AGENT} GoogleBot [NC]
RewriteRule ^u/([^/]+)/?$ /api.php?route=profile&username=$1 [L]

# Route public memory URLs to Node.js backend for Facebook/social media bots
# This allows proper meta tag generation for social sharing
RewriteCond %{HTTP_USER_AGENT} facebookexternalhit [NC,OR]
RewriteCond %{HTTP_USER_AGENT} facebookcatalog [NC,OR]
RewriteCond %{HTTP_USER_AGENT} Twitterbot [NC,OR]
RewriteCond %{HTTP_USER_AGENT} LinkedInBot [NC,OR]
RewriteCond %{HTTP_USER_AGENT} WhatsApp [NC,OR]
RewriteCond %{HTTP_USER_AGENT} Applebot [NC,OR]
RewriteCond %{HTTP_USER_AGENT} GoogleBot [NC]
RewriteRule ^u/([^/]+)/memory/([^/]+)/?$ /api.php?route=memory&username=$1&slug=$2 [L]

# React Router - All other requests go to React app
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/public/
RewriteRule . /index.html [L]

# Disable caching for API calls
<If "%{REQUEST_URI} =~ m#^/api/#">
    Header always set Cache-Control "no-cache, no-store, must-revalidate"
    Header always set Pragma "no-cache" 
    Header always set Expires "0"
</If>